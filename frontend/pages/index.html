<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alfred Control Panel</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: #0f172a;
        background: #f8fafc;
      }
      body {
        margin: 0;
        padding: 0;
        background: #f8fafc;
      }
      header {
        padding: 1.5rem 2rem;
        background: #0f172a;
        color: #f8fafc;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        gap: 1.5rem;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        padding: 1.5rem;
      }
      .card h2 {
        margin-top: 0;
      }
      label {
        font-size: 0.85rem;
        color: #475569;
        display: block;
        margin-bottom: 0.25rem;
      }
      input,
      textarea,
      select {
        width: 100%;
        border: 1px solid #cbd5f5;
        border-radius: 12px;
        padding: 0.65rem 0.85rem;
        font-size: 0.95rem;
        margin-bottom: 1rem;
        background: #f8fafc;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .btn {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.2s ease;
      }
      .btn.secondary {
        background: #e2e8f0;
        color: #0f172a;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        background: #1d4ed8;
      }
      .grid {
        display: grid;
        gap: 1rem;
      }
      .grid.two {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      .job-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 500px;
        overflow: auto;
      }
      .job-card {
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        padding: 1rem;
        background: #fff;
      }
      .job-card h3 {
        margin: 0;
      }
      pre {
        padding: 1rem;
        background: #0f172a;
        color: #f8fafc;
        border-radius: 12px;
        max-height: 300px;
        overflow: auto;
      }
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Alfred Control Panel</h1>
      <p>Manage your profile, preferences, and job generation workflow.</p>
    </header>
    <main class="container">
      <section class="card">
        <h2>API Endpoint</h2>
        <label>Backend Base URL</label>
        <div class="grid two">
          <input id="api-base" placeholder="http://127.0.0.1:8000" />
          <button class="btn" onclick="updateApiBase()">Use URL</button>
        </div>
      </section>

      <section class="card">
        <h2>Profile</h2>
        <p>Edit your immutable profile information. These details feed every resume.</p>
        <div id="profile-form"></div>
        <label>Full Profile JSON (advanced)</label>
        <textarea id="pf-json" style="min-height: 220px"></textarea>
        <small>Edit this JSON directly to add experiences, projects, etc. Saving will overwrite the entire profile.</small>
        <button class="btn" onclick="saveProfile()">Save Profile</button>
      </section>

      <section class="card">
        <h2>Job Preferences</h2>
        <div class="grid two">
          <div>
            <label for="pref-title">Target Title</label>
            <input id="pref-title" placeholder="e.g. Senior Data Engineer" />
          </div>
          <div>
            <label for="pref-location">Preferred Location</label>
            <input id="pref-location" placeholder="e.g. New York, Remote" />
          </div>
        </div>
        <button class="btn" onclick="savePreferences()">Save Preferences</button>
      </section>

      <section class="card">
        <div class="grid two">
          <div>
            <h2>Job Board</h2>
            <p>Fetched from Alfred backend (latest entries).</p>
          </div>
          <div style="text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="btn secondary" onclick="loadJobs()">Refresh Jobs</button>
            <button class="btn" onclick="fetchNewJobs()">Fetch New Jobs</button>
          </div>
        </div>
        <div class="job-list" id="jobs"></div>
      </section>

      <section class="card">
        <h2>Job Matches</h2>
        <div id="matches">Matches will appear here after selecting a job.</div>
      </section>

      <section class="card">
        <h2>Result Console</h2>
        <pre id="console">Select a job to view matches or generate documents.</pre>
      </section>
    </main>

    <script>
      let API_BASE = localStorage.getItem("alfredApiBase") || "http://127.0.0.1:8000";
      const profileForm = document.getElementById("profile-form");
      const jobsContainer = document.getElementById("jobs");
      const consoleEl = document.getElementById("console");
      const matchesContainer = document.getElementById("matches");

      document.getElementById("api-base").value = API_BASE;

      let profileData = {};

      function updateApiBase() {
        const value = document.getElementById("api-base").value.trim();
        if (!value) return;
        API_BASE = value;
        localStorage.setItem("alfredApiBase", value);
        consoleEl.textContent = `API base updated to ${value}. Reloading data...`;
        loadProfile();
        loadPreferences();
        loadJobs();
      }

      async function loadProfile() {
        try {
          const res = await fetch(`${API_BASE}/profile/`);
          if (!res.ok) throw new Error("Failed to load profile");
          profileData = await res.json();
          renderProfileForm(profileData);
        } catch (err) {
          console.error(err);
          consoleEl.textContent = `Profile load error: ${err}`;
        }
      }

      function renderProfileForm(data) {
        const personal = data.personal_info || {};
        profileForm.innerHTML = `
          <div class="grid two">
            <div>
              <label>Name</label>
              <input id="pf-name" value="${personal.name || ""}">
            </div>
            <div>
              <label>Location</label>
              <input id="pf-location" value="${personal.location || ""}">
            </div>
          </div>
          <div class="grid two">
            <div>
              <label>Email</label>
              <input id="pf-email" value="${personal.email || ""}">
            </div>
            <div>
              <label>Phone</label>
              <input id="pf-phone" value="${personal.phone || ""}">
            </div>
          </div>
          <label>Links (JSON array)</label>
          <textarea id="pf-links">${JSON.stringify(personal.links || [], null, 2)}</textarea>
          <label>Summary</label>
          <textarea id="pf-summary">${data.summary || ""}</textarea>
          <label>Core Skills (comma separated)</label>
          <textarea id="pf-skills">${(data.core_skills || []).join(", ")}</textarea>
        `;
        document.getElementById("pf-json").value = JSON.stringify(data, null, 2);
      }

      async function saveProfile() {
        let payload;
        const rawJson = document.getElementById("pf-json").value.trim();
        if (rawJson) {
          const parsed = safeParseJSON(rawJson);
          if (!parsed) {
            consoleEl.textContent = "Profile save error: Invalid JSON in advanced editor.";
            return;
          }
          payload = parsed;
        } else {
          payload = structuredClone(profileData);
          payload.personal_info = {
            name: document.getElementById("pf-name").value,
            location: document.getElementById("pf-location").value,
            email: document.getElementById("pf-email").value,
            phone: document.getElementById("pf-phone").value,
            links: safeParseJSON(document.getElementById("pf-links").value) || [],
          };
          payload.summary = document.getElementById("pf-summary").value;
          payload.core_skills = document
            .getElementById("pf-skills")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        }
        try {
          const res = await fetch(`${API_BASE}/profile/`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to save profile");
          consoleEl.textContent = "Profile saved.";
          profileData = payload;
        } catch (err) {
          consoleEl.textContent = `Profile save error: ${err}`;
        }
      }

      async function loadPreferences() {
        try {
          const res = await fetch(`${API_BASE}/profile/preferences`);
          if (!res.ok) throw new Error("Failed to load preferences");
          const prefs = await res.json();
          document.getElementById("pref-title").value = prefs.target_title || "";
          document.getElementById("pref-location").value = prefs.location || "";
        } catch (err) {
          consoleEl.textContent = `Preferences load error: ${err}`;
        }
      }

      async function savePreferences() {
        const payload = {
          target_title: document.getElementById("pref-title").value,
          location: document.getElementById("pref-location").value,
        };
        try {
          const res = await fetch(`${API_BASE}/profile/preferences`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to save preferences");
          consoleEl.textContent = "Preferences saved.";
        } catch (err) {
          consoleEl.textContent = `Preferences save error: ${err}`;
        }
      }

      async function loadJobs() {
        jobsContainer.innerHTML = "Loading jobs...";
        try {
          const res = await fetch(`${API_BASE}/jobs/`);
          if (!res.ok) throw new Error("Failed to load jobs");
          const jobs = await res.json();
          renderJobs(jobs.slice(-25).reverse());
        } catch (err) {
          jobsContainer.textContent = `Error loading jobs: ${err}`;
        }
      }

      function renderJobs(jobs) {
        if (!jobs.length) {
          jobsContainer.textContent = "No jobs found.";
          return;
        }
        jobsContainer.innerHTML = "";
        jobs.forEach((job) => {
          const card = document.createElement("div");
          card.className = "job-card";
          card.innerHTML = `
            <h3>${job.title}</h3>
            <p><strong>Company:</strong> ${job.company || "n/a"}</p>
            <p><strong>Location:</strong> ${job.location || "n/a"}</p>
            <p><strong>Description:</strong> ${job.description?.slice(0, 200) || "No description"}...</p>
            <div class="grid two">
              <button class="btn secondary" onclick="matchJob(${job.id})">View Matches</button>
              <button class="btn" onclick="generateResume(${job.id})">Resume</button>
              <button class="btn secondary" onclick="generateCoverLetter(${job.id})">Cover Letter</button>
            </div>
          `;
          jobsContainer.appendChild(card);
        });
      }

      async function fetchNewJobs() {
        consoleEl.textContent = "Fetching new jobs...";
        try {
          const res = await fetch(`${API_BASE}/jobs/fetch_jobs`, {
            method: "POST",
          });
          if (!res.ok) throw new Error("Fetch agent failed");
          consoleEl.textContent = "Job fetcher finished.";
          await loadJobs();
        } catch (err) {
          consoleEl.textContent = `Fetch jobs error: ${err}`;
        }
      }

      async function matchJob(jobId) {
        consoleEl.textContent = "Fetching matches...";
        try {
          const job = await fetch(`${API_BASE}/jobs/${jobId}`).then((r) => r.json());
          const payload = {
            title: job.title,
            company: job.company,
            description: job.description || "",
            top_k: 5,
          };
          const res = await fetch(`${API_BASE}/jobs/match`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Match request failed");
          const data = await res.json();
          renderMatches(data.matches || []);
        } catch (err) {
          consoleEl.textContent = `Match error: ${err}`;
          matchesContainer.textContent = "No matches.";
        }
      }

      async function generateResume(jobId) {
        consoleEl.textContent = "Generating resume...";
        await generateDoc(jobId, "resume");
      }

      async function generateCoverLetter(jobId) {
        consoleEl.textContent = "Generating cover letter...";
        await generateDoc(jobId, "cover");
      }

      async function generateDoc(jobId, type) {
        try {
          const job = await fetch(`${API_BASE}/jobs/${jobId}`).then((r) => r.json());
          const payload = {
            title: job.title,
            company: job.company,
            description: job.description || "",
            top_k: 5,
          };
          const endpoint =
            type === "resume" ? "/jobs/generate_resume_job_focus" : "/jobs/generate_cover_letter";
          const res = await fetch(`${API_BASE}${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Generation failed");
          const data = await res.json();
          consoleEl.textContent = data.generated_resume || data.generated_cover_letter || "No content";
        } catch (err) {
          consoleEl.textContent = `Generation error: ${err}`;
        }
      }

      function safeParseJSON(text) {
        try {
          return JSON.parse(text);
        } catch {
          return null;
        }
      }

      function renderMatches(matches) {
        if (!matches.length) {
          matchesContainer.textContent = "No matches returned for this job.";
          return;
        }
        matchesContainer.innerHTML = "";
        matches.forEach((match) => {
          const div = document.createElement("div");
          div.className = "job-card";
          div.innerHTML = `
            <h3>${match.name || "Artifact"}</h3>
            <p><strong>Source:</strong> ${match.source || "n/a"}</p>
            <p><strong>Combined Score:</strong> ${(match.combined_score || 0).toFixed(3)}</p>
            <p><strong>Snippet:</strong> ${match.snippet || ""}</p>
          `;
          matchesContainer.appendChild(div);
        });
      }

      loadProfile();
      loadPreferences();
      loadJobs();
    </script>
  </body>
</html>
